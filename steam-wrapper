#!/usr/bin/env bash

set -o pipefail

##
# Wrapper wrapper_version
##
wrapper_version=0.2.0

##
# steam-wrapper
# Packaged by: pyamsoft <pyam(dot)soft(at)gmail(dot)com>
##

##
# Check the environment path for the given binary, exit if it is not found
##
check_binary() {
  if ! which "$1" > /dev/null 2>&1; then
    printf -- "The '%s' binary is required for operation of this script.\n" "$1"
    printf -- "Please install '%s' onto your system.\n" "$1"
    exit 1
  fi
}

##
# Log opening
##
log_opening()
{
  if [[ "${debug}" -eq 1 ]]; then
    printf -- "steam-wrapper[${wrapper_version}]: Launched on " >> "${log}"
    printf -- "$(date +%Y-%m-%d) at $(date +%R) [$(date +%r)]\n" >> "${log}"
  fi
}

##
# Log the steam-wrapper configuration location
##
log_config_location()
{
  if [[ "${debug}" -eq 1 ]]; then
    printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
    if [[ ! -z ${conf_location} ]]; then
      printf -- "Configuration file found at: ${conf_location}\n" >> "${log}"
    else
      printf -- "Using preset defaults.\n" >> "${log}"
    fi
  fi
}

##
# Has required Steam folders
##
steam_folder_exists()
{
  if [[ -d "${HOME}/.steam" ]]; then
    if [[ "${debug}" -eq 1 ]]; then
      printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
      printf -- "Steam folder exists, can continue\n" >> "${log}"
    fi
    return 0
  else
    if [[ "${debug}" -eq 1 ]]; then
      printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
      printf -- "Steam folder does not exist, launch Steam once first\n" >> "${log}"
    fi
    printf -- "steam-wrapper[${wrapper_version}]: "
    printf -- "Steam folder does not exist, launch Steam once first\n"
    return 1
  fi
}

##
# Remove some files that apperantly conflict with native runtimes on ArchLinux
#
# Read for details:
#     https://wiki.archlinux.org/index.php/steam#Steam_runtime_issues
##
remove_stale_files()
{
  if [[ "${debug}" -eq 1 ]]; then
    printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
    printf -- "Attempting removal of stale libraries...\n" >> "${log}"
    find "${HOME}/.steam/root/" \( -name "libgcc_s.so*" \
      -o -name "libasound.so*" -o -name "libstdc++.so*" \
      -o -name "libxcb.so*" \) -print -delete >> "${log}"
    find "${HOME}/.local/share/Steam/" \( -name "libgcc_s.so*" \
      -o -name "libasound.so*" -o -name "libstdc++.so*" \
      -o -name "libxcb.so*" \) -print -delete >> "${log}"
  else
    find "${HOME}/.steam/root/" \( -name "libgcc_s.so*" \
      -o -name "libasound.so*" -o -name "libstdc++.so*" \
      -o -name "libxcb.so*" \) -delete
    find "${HOME}/.local/share/Steam/" \( -name "libgcc_s.so*" \
      -o -name "libasound.so*" -o -name "libstdc++.so*" \
      -o -name "libxcb.so*" \) -delete
  fi
}

##
# Link the flash player library on 64 bit systems
##
link_lib32_flash()
{
  local arch=$(uname -m)
  if [[ $arch = "x86_64" ]]; then
    if [[ "${debug}" -eq 1 ]]; then
      printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
      printf -- "Attempt linking of lib32 libflashplayer.so\n" >> "${log}"
    fi
    if [[ -f "${HOME}/.steam/bin/plugins/libflashplayer.so" ]]; then
      if [[ "${debug}" -eq 1 ]]; then
        printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
        printf -- "Flashplayer is already linked.\n" >> "${log}"
      fi
    elif [[ -f "/usr/lib32/mozilla/plugins/libflashplayer.so" ]]; then
      mkdir -p "${HOME}/.steam/bin/plugins"
      ##
      # This path to the flashplugin may be different on
      # other distributions, this is the path on ArchLinux.
      ##
      ln -sf /usr/lib32/mozilla/plugins/libflashplayer.so \
        "${HOME}/.steam/bin/plugins/libflashplayer.so"
      if [[ "${debug}" -eq 1 ]]; then
        printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
        printf -- "Linked libflashplayer.so\n" >> "${log}"
      fi
    else
      if [[ "${debug}" -eq 1 ]]; then
        printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
        printf -- "Cannot find libflashplayer.so\n" >> "${log}"
      fi
    fi
  fi
  unset arch
}

##
# Log the wrapper variables used.
##
log_wrapper_usage()
{
  if [[ "${debug}" -eq 1 ]]; then
    printf -- "steam-wrapper[${wrapper_version}]: Done.\n" >> "${log}"
    printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
    printf -- "Launching Steam with environment:\n" >> "${log}"
    printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
    printf -- "    STEAM_RUNTIME = %s\n" "${use_runtime}" >> "${log}"
    printf -- "steam-wrapper[${wrapper_version}]: " >> "${log}"
    printf -- "    STEAM_FRAME_FORCE_CLOSE = %s\n" "${close_to_tray}" >> "${log}"
    printf -- "\n" >> "${log}"
  fi
}

##
# Searches for the steam-wrapper.conf file in a couple of specified locations.
# The first found file will be used as the configuration file
##
find_conf()
{
  local conf_location=""
  if [[ -f ${HOME}/.steam-wrapper/steam-wrapper.conf ]]; then
    conf_location="${HOME}/.steam-wrapper/steam-wrapper.conf"
  elif [[ -f ${HOME}/.steam-wrapper.conf ]]; then
    conf_location="${HOME}/.steam-wrapper.conf"
  elif [[ -f /etc/steam-wrapper/steam-wrapper.conf ]]; then
    conf_location="/etc/steam-wrapper/steam-wrapper.conf"
  elif [[ -f /etc/steam-wrapper.conf ]]; then
    conf_location="/etc/steam-wrapper.conf"
  fi
  printf -- "${conf_location}"
  unset conf_location
}

main()
{
  local conf_location=
  local debug=
  local use_runtime=
  local close_to_tray=
  local logdir=
  local log=

  conf_location=$(find_conf) || return 1

  ##
  # If a configuration file was present, source it for use, otherwise
  # we will use pre-defined varialbes which are arguably sensible by
  # default.
  ##
  if [[ "${conf_location}" != "" ]]; then
    source "${conf_location}"
  else
    debug=1
    use_runtime=1
    close_to_tray=1
    logdir="${HOME}/.steam-wrapper/"
  fi

  # Create logdir
  log="${logdir}/steam-wrapper.log"
  mkdir -p "${logdir}"

  log_opening || return 1
  log_config_location || return 1

  # Allow the user to over ride the runtime and close to tray by
  # passing in command line arguments
  # Use runtime
  if [[ ! -z "$1" ]]; then
    case "$1" in
      "1"|"on"|"ON"|"yes"|"YES"|"y"|"Y")
        use_runtime=1
        if [[ "${debug}" -eq 1 ]]; then
          printf -- "steam-wrapper[${wrapper_version}]:" >> "${log}"
          printf -- " Value of: \$use_runtime overwritten" >> "${log}"
          printf -- " by cmd argument: %s\n" "${use_runtime}" >> "${log}"
        fi
        ;;
      "0"|"off"|"OFF"|"no"|"NO"|"n"|"N")
        use_runtime=0
        if [[ "${debug}" -eq 1 ]]; then
          printf -- "steam-wrapper[${wrapper_version}]:" >> "${log}"
          printf -- " Value of: \$use_runtime overwritten" >> "${log}"
          printf -- " by cmd argument: %s\n" "${use_runtime}" >> "${log}"
        fi
        ;;
      *)
        printf -- "Invalid option passed.\n"
        return 1
        ;;
    esac

    # Close to tray
    if [[ ! -z "$2" ]]; then
      case "$2" in
        "1"|"on"|"ON"|"yes"|"YES"|"y"|"Y")
          close_to_tray=1
          if [[ "${debug}" -eq 1 ]]; then
          printf -- "steam-wrapper[${wrapper_version}]:" >> "${log}"
          printf -- " Value of: \$close_to_tray overwritten" >> "${log}"
          printf -- " by cmd argument: %s\n" "${close_to_tray}" >> "${log}"
          fi
          ;;
        "0"|"off"|"OFF"|"no"|"NO"|"n"|"N")
          close_to_tray=0
          if [[ "${debug}" -eq 1 ]]; then
          printf -- "steam-wrapper[${wrapper_version}]:" >> "${log}"
          printf -- " Value of: \$close_to_tray overwritten" >> "${log}"
          printf -- " by cmd argument: %s\n" "${close_to_tray}" >> "${log}"
          fi
          ;;
        *)
          printf -- "Invalid option passed.\n"
          return 1
          ;;
      esac
    fi
  fi

  steam_folder_exists || return 1
  remove_stale_files || return 1
  link_lib32_flash || return 1
  log_wrapper_usage || return 1

  ##
  # Clean up some of the unused vars
  ##
  unset debug logdir log conf_location

  ##
  # Run steam using the wrapper
  ##
  exec env \
    STEAM_RUNTIME="${use_runtime}" \
    STEAM_FRAME_FORCE_CLOSE="${close_to_tray}" \
    steam "$@"
  return 0
}

# Check for required binaries, exit out if they are not present
check_binary find
check_binary printf
check_binary steam

main $@ || exit 1
exit 0

# vim: set syntax=sh tabstop=2 softtabstop=2 shiftwidth=2 shiftround expandtab:
