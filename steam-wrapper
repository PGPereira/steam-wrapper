#!/usr/bin/env bash

set -e

##
# Wrapper version
##
VERSION=0.1.7

##
# steam-wrapper
# Packaged by: pyamsoft <pyam(dot)soft(at)gmail(dot)com>
##

##
# Log opening
##
function log_opening()
{
	if [[ $DEBUG -eq 1 ]]; then
		echo -n "steam-wrapper[$VERSION]: Launched on " >> $LOG
		echo "$(date +%Y-%m-%d) at $(date +%R) [$(date +%r)]" >> $LOG
	fi
}

##
# Log the steam-wrapper configuration location
##
function log_config_location()
{
	if [[ $DEBUG -eq 1 ]]; then
		if [[ $CONF_LOCATION != "" ]]; then
			echo -n "steam-wrapper[$VERSION]: " >> $LOG
			echo -n "Configuration file " >> $LOG
			echo "found at: $CONF_LOCATION" >> $LOG
		else
			echo -n "steam-wrapper[$VERSION]: " >> $LOG
			echo -n "No configuration " >> $LOG
			echo "file found" >> $LOG
			echo "Using preset defaults." >> $LOG
		fi
	fi
}

##
# Has required Steam folders
##
function steam_folder_exists()
{
	if [[ -d $HOME/.local/share/Steam ]]; then
		echo -n "steam-wrapper[$VERSION]: Steam folder " >> $LOG
		echo "exists, can continue" >> $LOG
		return 0
	else
		echo -n "steam-wrapper[$VERSION]: Steam folder " >> $LOG
		echo "doesn't exist, bail out" >> $LOG
		return 1
	fi
}

##
# Remove some files that apperantly conflict with native runtimes on ArchLinux
#
# Read for details:
#     https://wiki.archlinux.org/index.php/steam#Steam_runtime_issues
##
function remove_stale_files()
{
	if [[ $DEBUG -eq 1 ]]; then
		echo -n "steam-wrapper[$VERSION]: Attempting removal " >> $LOG
		echo "of stale libraries..." >> $LOG
		find $HOME/.local/share/Steam/ \( -name "libgcc_s.so*" -o \
			-name "libstdc++.so*" -o -name "libxcb.so*" \) \
			-delete -print >> $LOG
	else
		find $HOME/.local/share/Steam/ \( -name "libgcc_s.so*" -o \
			-name "libstdc++.so*" -o -name "libxcb.so*" \) -delete
	fi
}

##
# Link the flash player library on 64 bit systems
##
function link_lib32_flash()
{
	local ARCH=$(uname -m)
	if [[ $ARCH = "x86_64" ]]; then
		[[ $DEBUG -eq 1 ]] && {
			echo -n "steam-wrapper[$VERSION]: " >> $LOG
			echo -n "Attempt linking of lib32 " >> $LOG
			echo "libflashplayer.so" >> $LOG
		}
		if [[ -f $HOME/.steam/bin/plugins/libflashplayer.so ]]; then
			if [[ $DEBUG -eq 1 ]]; then
				echo -n "steam-wrapper[$VERSION]: " >> $LOG
				echo "Flashplayer is already linked." >> $LOG
			fi
		elif [[ -f /usr/lib32/mozilla/plugins/libflashplayer.so ]]; then
			mkdir -p $HOME/.steam/bin/plugins
			##
			# This path to the flashplugin may be different on
			# other distributions, this is the path on ArchLinux.
			##
			ln -sf /usr/lib32/mozilla/plugins/libflashplayer.so \
				$HOME/.steam/bin/plugins/libflashplayer.so
			if [[ $DEBUG -eq 1 ]]; then
				echo -n "steam-wrapper[$VERSION]: " >> $LOG
				echo "Linked libflashplayer.so" >> $LOG
			fi
		else
			if [[ $DEBUG -eq 1 ]]; then
				echo -n "steam-wrapper[$VERSION]: " >> $LOG
				echo "Cannot find libflashplayer.so" >> $LOG
			fi
		fi
	fi
	unset ARCH
}

##
# Log the wrapper variables used.
##
function log_wrapper_usage()
{
	if [[ $DEBUG -eq 1 ]]; then
		echo "steam-wrapper[$VERSION]: Done." >> $LOG
		echo -n "steam-wrapper[$VERSION]: Launching steam with" >> $LOG
		echo " environment:" >> $LOG
		echo -n "steam-wrapper[$VERSION]:     STEAM_RUNTIME =" >> $LOG
		echo " ${USE_RUNTIME}" >> $LOG
		echo -n "steam-wrapper[$VERSION]:     " >> $LOG
		echo -n "STEAM_FRAME_FORCE_CLOSE = " >> $LOG
		echo "${CLOSE_TO_TRAY}" >> $LOG
		echo >> $LOG
	fi
}

##
# Searches for the steam-wrapper.conf file in a couple of specified locations.
# The first found file will be used as the configuration file
##
function find_conf()
{
	local CONF_LOCATION=""
	if [[ -f $HOME/.steam-wrapper/steam-wrapper.conf ]]; then
		CONF_LOCATION="$HOME/.steam-wrapper/steam-wrapper.conf"
	elif [[ -f $HOME/.steam-wrapper.conf ]]; then
		CONF_LOCATION="$HOME/.steam-wrapper.conf"
	elif [[ -f /etc/steam-wrapper/steam-wrapper.conf ]]; then
		CONF_LOCATION="/etc/steam-wrapper/steam-wrapper.conf"
	elif [[ -f /etc/steam-wrapper.conf ]]; then
		CONF_LOCATION="/etc/steam-wrapper.conf"
	fi
	echo $CONF_LOCATION
	unset CONF_LOCATION
}

function main()
{

	local CONF_LOCATION
	local DEBUG
	local USE_RUNTIME
	local CLOSE_TO_TRAY
	local LOGDIR
	local LOG

	CONF_LOCATION=$(find_conf) || return 1

	##
	# If a configuration file was present, source it for use, otherwise
	# we will use pre-defined varialbes which are arguably sensible by
	# default.
	##
	if [[ $CONF_LOCATION != "" ]]; then
		source $CONF_LOCATION
	else
		DEBUG=1
		USE_RUNTIME=1
		CLOSE_TO_TRAY=1
		LOGDIR="$HOME/.steam-wrapper/"
	fi

	LOG="$LOGDIR/steam-wrapper.log"
	mkdir -p $LOGDIR

	log_opening || return 1
	log_config_location || return 1
	steam_folder_exists || return 1
	remove_stale_files || return 1
	link_lib32_flash || return 1
	log_wrapper_usage || return 1

	##
	# Clean up some of the unused vars
	##
	unset DEBUG LOGDIR LOG CONF_LOCATION

	##
	# Run steam using the wrapper
	##
	exec env \
		STEAM_RUNTIME="${USE_RUNTIME}" \
		STEAM_FRAME_FORCE_CLOSE="${CLOSE_TO_TRAY}" \
		steam "$@"
	return 0
}

main || exit 1
exit 0

