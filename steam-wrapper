#!/usr/bin/env bash

# Wrapper version
VERSION=0.1.4

#####################################################################
# steam-wrapper
# Packaged by: pyamsoft <pyam.soft@gmail.com>
#####################################################################


CONF_LOCATION=""
if [[ -f $HOME/.steam-wrapper/steam-wrapper.conf ]]; then
	CONF_LOCATION="$HOME/.steam-wrapper/steam-wrapper.conf"
elif [[ -f $HOME/.steam-wrapper.conf ]]; then
	CONF_LOCATION="$HOME/.steam-wrapper.conf"
elif [[ -f /etc/steam-wrapper/steam-wrapper.conf ]]; then
	CONF_LOCATION="/etc/steam-wrapper/steam-wrapper.conf"
elif [[ -f /etc/steam-wrapper.conf ]]; then
	CONF_LOCATION="/etc/steam-wrapper.conf"
fi

if [[ $CONF_LOCATION != "" ]]; then
	source $CONF_LOCATION
else
	DEBUG=1
	USE_RUNTIME=1
	CLOSE_TO_TRAY=1
	LOGDIR="$HOME/.steam-wrapper/"
fi

# Create the log directory
LOG="$LOGDIR/steam-wrapper.log"
mkdir -p $LOGDIR

# Log opening
if [[ $DEBUG -eq 1 ]]; then
	echo "steam-wrapper[$VERSION]: Launched on $(date +%Y-%m-%d) at $(date +%R) [$(date +%r)]" >> $LOG
fi

if [[ $DEBUG -eq 1 ]]; then
	if [[ $CONF_LOCATION != "" ]]; then
		echo "steam-wrapper[$VERSION]: Configuration file found at: $CONF_LOCATION" >> $LOG
	else
		echo "steam-wrapper[$VERSION]: No configuration file found" >> $LOG
		echo "Using preset defaults." >> $LOG
	fi
fi

# Remove some files that apperantly conflict with native runtimes on ArchLinux
if [[ $DEBUG -eq 1 ]]; then
	echo "steam-wrapper[$VERSION]: Attempting removal of stale libraries..." >> $LOG
fi

# Read for details:
#     https://wiki.archlinux.org/index.php/steam#Steam_runtime_issues
if [[ $DEBUG -eq 1 ]]; then
	find $HOME/.local/share/Steam/ \( -name "libgcc_s.so*" -o -name "libstdc++.so*" -o -name "libxcb.so*" \) -delete -print >> $LOG
else
	find $HOME/.local/share/Steam/ \( -name "libgcc_s.so*" -o -name "libstdc++.so*" -o -name "libxcb.so*" \) -delete
fi

if [[ $DEBUG -eq 1 ]]; then
	echo "steam-wrapper[$VERSION]: Done." >> $LOG
	echo "steam-wrapper[$VERSION]: Launching steam with environment:" >> $LOG
	echo "steam-wrapper[$VERSION]:     STEAM_RUNTIME = ${USE_RUNTIME}" >> $LOG
	echo "steam-wrapper[$VERSION]:     STEAM_FRAME_FORCE_CLOSE = ${CLOSE_TO_TRAY}" >> $LOG
	echo >> $LOG
fi

# Run steam using the wrapper
exec env \
	STEAM_RUNTIME="${USE_RUNTIME}" \
	STEAM_FRAME_FORCE_CLOSE="${CLOSE_TO_TRAY}" \
	steam "$@"
