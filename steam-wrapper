#!/usr/bin/env bash

##
# Wrapper version
##
VERSION=0.1.4

##
# steam-wrapper
# Packaged by: pyamsoft <pyam.soft@gmail.com>
##

##
# Searches for the steam-wrapper.conf file in a couple of specified locations.
# The first found file will be used as the configuration file
##
CONF_LOCATION=""
if [[ -f $HOME/.steam-wrapper/steam-wrapper.conf ]]; then
	CONF_LOCATION="$HOME/.steam-wrapper/steam-wrapper.conf"
elif [[ -f $HOME/.steam-wrapper.conf ]]; then
	CONF_LOCATION="$HOME/.steam-wrapper.conf"
elif [[ -f /etc/steam-wrapper/steam-wrapper.conf ]]; then
	CONF_LOCATION="/etc/steam-wrapper/steam-wrapper.conf"
elif [[ -f /etc/steam-wrapper.conf ]]; then
	CONF_LOCATION="/etc/steam-wrapper.conf"
fi

##
# If a configuration file was present, source it for use, otherwise
# we will use pre-defined varialbes which are arguably sensible by default.
##
if [[ $CONF_LOCATION != "" ]]; then
	source $CONF_LOCATION
else
	DEBUG=1
	USE_RUNTIME=1
	CLOSE_TO_TRAY=1
	LOGDIR="$HOME/.steam-wrapper/"
fi

##
# Create the log directory
##
LOG="$LOGDIR/steam-wrapper.log"
mkdir -p $LOGDIR

##
# Log opening
##
if [[ $DEBUG -eq 1 ]]; then
	echo "steam-wrapper[$VERSION]: Launched on $(date +%Y-%m-%d) at \
		$(date +%R) [$(date +%r)]" >> $LOG
fi

##
# Log the steam-wrapper configuration location
##
if [[ $DEBUG -eq 1 ]]; then
	if [[ $CONF_LOCATION != "" ]]; then
		echo "steam-wrapper[$VERSION]: Configuration file found \
			at: $CONF_LOCATION" >> $LOG
	else
		echo "steam-wrapper[$VERSION]: No configuration file \
			found" >> $LOG
		echo "Using preset defaults." >> $LOG
	fi
fi

##
# Remove some files that apperantly conflict with native runtimes on ArchLinux
#
# Read for details:
#     https://wiki.archlinux.org/index.php/steam#Steam_runtime_issues
##
if [[ $DEBUG -eq 1 ]]; then
	echo "steam-wrapper[$VERSION]: Attempting removal of stale libraries..." >> $LOG
	find $HOME/.local/share/Steam/ \( -name "libgcc_s.so*" -o -name \
		"libstdc++.so*" -o -name "libxcb.so*" \) -delete -print >> $LOG
else
	find $HOME/.local/share/Steam/ \( -name "libgcc_s.so*" -o -name \
		"libstdc++.so*" -o -name "libxcb.so*" \) -delete
fi

##
# Log the wrapper variables used.
##
if [[ $DEBUG -eq 1 ]]; then
	echo "steam-wrapper[$VERSION]: Done." >> $LOG
	echo "steam-wrapper[$VERSION]: Launching steam with environment:" >> $LOG
	echo "steam-wrapper[$VERSION]:     STEAM_RUNTIME = ${USE_RUNTIME}" >> $LOG
	echo "steam-wrapper[$VERSION]:     STEAM_FRAME_FORCE_CLOSE = ${CLOSE_TO_TRAY}" >> $LOG
	echo >> $LOG
fi

##
# Run steam using the wrapper
##
exec env \
	STEAM_RUNTIME="${USE_RUNTIME}" \
	STEAM_FRAME_FORCE_CLOSE="${CLOSE_TO_TRAY}" \
	steam "$@"
